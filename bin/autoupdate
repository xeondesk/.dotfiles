#!/usr/bin/env zsh

##############################################################################
# autoupdate - System and dotfiles update script
##############################################################################
#
# Description: Updates system packages, dotfiles, shell plugins, editor configs
# and various development tools. Can be run manually or on a schedule.
#
# Usage:
#   autoupdate              # Updates if interval has passed
#   autoupdate --force      # Force update regardless of interval
#
# Environment Variables:
#   SYSTEM_UPDATE_DAYS      Days between automatic updates (default: 7)
#   SYSTEM_RECEIPT_F        File to track last update time (default: .system_lastupdate)
#
# Features:
#   - Automatic interval checking
#   - Updates chezmoi dotfiles
#   - Updates zsh plugin manager (zinit)
#   - Updates Neovim plugins
#   - Updates npm/npm/python packages
#   - Updates documentation cache (tldr)
#   - Can be sourced to use as function in shell
#
##############################################################################

# Determine if script is being sourced or executed
# sourced=0 means executed as script, sourced=1 means sourced into shell
[[ $0 =~ "autoupdate.zsh" ]] && sourced=0 || sourced=1

##############################################################################
# Error Handling
##############################################################################

# Track errors from various update commands in an array
declare -a update_errors=()
tp='success'

# Function: Track command errors
# Parameters: $1 = command name, $2 = exit code
function update_error() {
	local error_cmd=$1
	local error_code=$2
	if [ $error_code -ne 0 ]; then
		update_errors+=("$error_cmd: $error_code")
	fi
}

# Function: Display error summary and exit
function show_errors() {
	if [ ${#update_errors[@]} -ne 0 ]; then
		tp='error'
		echo "Errors occurred during update:"
		for error in "${update_errors[@]}"; do
			echo "  $error"
		done
	fi
	# If sourced into shell, use term-notify; otherwise exit with status
	if [ $sourced -eq 1 ]; then
		term-notify $tp $interval <<<"autoupdate.zsh"
	else
		if [ $tp = 'success' ]; then
			exit 0
		else
			exit 1
		fi
	fi
}

##############################################################################
# Utility Functions
##############################################################################

# Function: Check interval since last update
# Parameters: $1 = receipt filename
# Returns: Seconds since last update
function check_interval() {
	local receipt_file=$1
	local now current_update
	now=$(date +%s)
	
	if [ -f ~/${receipt_file} ]; then
		current_update=$(cat ~/${receipt_file})
	else
		current_update=0
	fi
	
	echo $((now - current_update))
}

# Function: Stop progress spinner and restore cursor
function revolver_stop() {
	revolver stop
	tput cnorm
}

if [ -z "$SYSTEM_UPDATE_DAYS" ]; then
	SYSTEM_UPDATE_DAYS=7
fi

if [ -z "$SYSTEM_RECEIPT_F" ]; then
	SYSTEM_RECEIPT_F='.system_lastupdate'
fi

# Parse command-line options
if [ "$1" = "--force" ]; then
	force_update=1
else
	force_update=0
fi

# Calculate time thresholds
day_seconds=86400
system_seconds=$(expr ${day_seconds} \* ${SYSTEM_UPDATE_DAYS})

last_system=$(check_interval ${SYSTEM_RECEIPT_F})

# Execute updates if threshold passed or forced
if [ ${last_system} -gt ${system_seconds} ] || [ $force_update -eq 1 ]; then
	start_time=$(date +%s)

	# Record update time
	$(date +%s >~/${SYSTEM_RECEIPT_F})
	echo "It has been $(expr ${last_system} / $day_seconds) days since system was updated"
	echo "Updating system... Please open a new terminal to continue your work in parallel..."

	# Initialize progress display
	if command -v revolver >/dev/null 2>&1; then
		tput civis
		revolver --style 'dots2' start 'Pulling latest dotfiles...'
	fi

	##################################################################
	# 1. DOTFILES UPDATE
	##################################################################
	cd ~ && chezmoi --force update -v
	update_error dotfiles $?

	##################################################################
	# 2. PERSONAL AUTOUPDATE HOOKS
	##################################################################
	revolver update "Running personal autoupdates..."
	# safe way to source local configuration
	if [ -f "$HOME/.autoupdate_local.zsh" ]; then
		# validate that the file is readable and not a symlink to untrusted location
		if [ -r "$HOME/.autoupdate_local.zsh" ] && [ ! -L "$HOME/.autoupdate_local.zsh" ]; then
			source "$HOME/.autoupdate_local.zsh" || {
				update_error ~/.autoupdate_local.zsh $?
			}
		else
			echo "⚠️  Cannot read or untrusted symlink: $HOME/.autoupdate_local.zsh" >&2
			update_error ~/.autoupdate_local.zsh 1
		fi
	fi

  if command -v revolver >/dev/null 2>&1; then
    revolver_stop
  fi
	~/sw/bin/sync_brews.sh
	update_error sync_brews $?

  revolver --style 'dots2' start 'Updating zinit... (Press q or Enter if this is taking too long)'
	source $HOME/.local/share/zinit/zinit.git/zinit.zsh && zinit self-update && zinit update --quiet --parallel 8 && zinit cclear
	update_error zinit $?

  revolver update "Updating nvim... (Press Spaces if this is taking too long)"
	nvim +PlugUpgrade +PlugClean! +PlugUpdate +PlugInstall +CocUpdateSync +TSUpdateSync +qall
	update_error nvim $?

  revolver update "Updating npm packages..."
	npm update && npm upgrade && npm audit fix --force && npm prune --production --force
	update_error npm $?

  revolver update "Updating pip packages..."
	# upgrade pip and pip packages
	pip3 install --quiet --upgrade pip setuptools wheel && pip3 freeze --local | grep -v '^\-e' | cut -d = -f 1 | xargs -n1 pip3 install --quiet --upgrade
	update_error pip $?


  revolver update "Updating tldr cache..."
	# update tldr
	tldr --update
  
  revolver update "Syncing styles in $HOME/notes"
  pushd $HOME/notes && vale sync && popd

  revolver_stop

  $HOME/sw/bin/sync_coderabbitai.sh
  $HOME/sw/bin/sync_fluxninja.sh

  if [[ $TERM == *"tmux"* || $TERM == *"screen"* || -n $TMUX ]]; then
    tmux source-file $HOME/.tmux.conf
  fi

	stop_time=$(date +%s)
	interval=$(expr ${stop_time} - ${start_time})
	echo "It took $interval seconds to update the system."
	show_errors
fi

unset SYSTEM_RECEIPT_F
unset SYSTEM_UPDATE_DAYS
unset day_seconds
unset last_system
unset system_seconds
unset start_time
unset stop_time
unset interval
unset force_update
unset update_errors
unset check_interval
unset error_code
unset error_cmd
unset tp
unset -f update_error
unset -f check_interval
unset -f show_errors
unset -f revolver_stop
