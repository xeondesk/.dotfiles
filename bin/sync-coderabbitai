#!/usr/bin/env bash
set -euo pipefail

# Check for required dependencies  
for cmd in gh-clone-all pull_all find; do
	if ! command -v "$cmd" >/dev/null 2>&1; then
		echo "âŒ Error: Required command '$cmd' not found" >&2
		exit 1
	fi
done

gh-clone-all coderabbitai "$HOME/Work" || exit 1
pull_all "$HOME/Work/coderabbitai" || exit 1

# go through all the directories in ~/Work/coderabbitai
# look for package.json files in the subdirectories
# and run pnpm install in those directories
find "$HOME/Work/coderabbitai" -maxdepth 2 -name package.json -exec dirname {} \; | while read -r dir; do
  # if the directory contains a pnpm-lock.yaml file use pnpm
  # otherwise look for a yarn.lock file and use yarn
  # otherwise look for a package-lock.json file and use npm
  if [ -f "$dir/pnpm-lock.yaml" ]; then
    echo "Running pnpm install in $dir"
    (cd "$dir" && pnpm install)
  elif [ -f "$dir/yarn.lock" ]; then
    echo "Running yarn install in $dir"
    (cd "$dir" && yarn install)
  elif [ -f "$dir/package-lock.json" ]; then
    echo "Running npm install in $dir"
    (cd "$dir" && npm install)
  fi
done

# install husky git hooks in coderabbitai/mono
if [ -d "$HOME/Work/coderabbitai/mono" ]; then
  echo "Installing husky git hooks in $HOME/Work/coderabbitai/mono"
  (cd "$HOME/Work/coderabbitai/mono" && husky)
fi
